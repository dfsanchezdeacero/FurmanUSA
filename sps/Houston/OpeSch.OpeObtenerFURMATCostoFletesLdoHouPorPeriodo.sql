CREATE PROCEDURE [OPESch].[OpeObtenerFURMATCostoFletesLdoHouPorPeriodo]	 
	@pnAnioMesInicio INT
	,@pnAnioMesFin	 INT
AS
BEGIN
	SET NOCOUNT ON				SELECT 			 FURMAT = SUM((D.PesoEmbarcado / EC.TotPesoViaje) * T.ImportePagarFinal)/SUM(D.PesoEmbarcado)		FROM	OPESCH.OpeTraMovEntSal E WITH(NOLOCK)			INNER JOIN OPESCH.OpeTraMovEntSalDet D WITH(NOLOCK) ON E.ClaUbicacion = D.ClaUbicacion AND E.IdMovEntsal = D.IdMovEntsal			OUTER APPLY (SELECT SUM(EC.PesoEmbarcado) AS TotPesoViaje FROM	OPESCH.OpeTraMovEntSal EC WITH(NOLOCK)  WHERE E.ClaUbicacion= EC.ClaUbicacion AND E.IdViaje= EC.IdViaje) EC			INNER JOIN OPESCH.ArtCatArticuloVW A WITH(NOLOCK)  ON D.ClaArticulo = A.ClaArticulo 			INNER JOIN OPESCH.ArtCatFamiliaVW F WITH(NOLOCK)  ON  A.ClaFamilia =F.ClaFamilia AND A.ClaTipoInventario = F.ClaTipoInventario			INNER JOIN OPESCH.OPETRAVIAJE V WITH(NOLOCK) ON  E.CLAUBICACION = V.CLAUBICACION AND E.IDVIAJE= V.IDVIAJE			INNER JOIN FleSch.FleTraTabular T WITH(NOLOCK) ON  V.CLAUBICACION = T.CLAUBICACION AND V.IdNumTabular= T.IdTabular			INNER JOIN  ManSch.ManRelArticuloComposicion S ON S.CLAPLANTA= 65 AND  D.ClaArticulo =  S.ClaArticuloComp AND S.BajaLogica=  0 AND S.ClaTipoComponente = 1			INNER JOIN OPESCH.ArtCatArticuloVW AC WITH(NOLOCK)  ON S.ClaArticulo = AC.ClaArticulo 		WHERE	E.ClaUbicacion = 345				AND (@pnAnioMesInicio IS NULL OR (@pnAnioMesInicio IS NOT NULL AND (YEAR(E.FechaEntsal) * 100 + MONTH(E.FechaEntsal)) >= @pnAnioMesInicio))
				AND (@pnAnioMesFin IS NULL OR (@pnAnioMesFin IS NOT NULL AND  (YEAR(E.FechaEntsal) * 100 + MONTH(E.FechaEntsal)) <= @pnAnioMesFin))					AND E.ClaMotivoentrada = 1								AND E.IdFactura IS NULL				AND E.ClaUbicacionDestino = 65 					SET NOCOUNT OFFEND